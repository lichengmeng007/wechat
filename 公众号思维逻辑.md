##微信交互流程图
![](https://i.imgur.com/xdtweXt.png)












##验证服务器有效性

1.接收微信消息(中间件)

2.本地开启的服务没办法在互联网中访问：ngrok通过内网网穿透解决指令：
.ngrok htpp 3000

.签名生效是因为有个东西不能模拟，token在微信服务器，别人拿不到

.填写服务器配置（告诉微信开发者服务器位于哪）修改:接口配置信息里的url

.得到微信签名，来验证请求是否来自微信服务器

.需要将三个参数（timestamp,nonce,token）组合在一起，按照字典序
（0-9 a-z 依次比较）
排序(sort)

.将排序后的参数拼接成字符串，进行sha1加密

.sha1[timestamp,nonce,token].sort().join('')

.加密后的就是微信签名，我们需要与signatrue进行对比，如果一样，

.消息来自微信服务器，返回响应echoster(告诉微信服务器，我开发者服务器是ok的)

.如果不一样，说明消息不是微信服务器的，返回err


.当点击提交按钮时，微信服务器会发送消息到开发者服务器，我们要验证消息是否来自于微信服务器

.获取请求参数(结构赋值)

.定义配置对象，微信公众号的信息保存下来(三个)

##接受用户的消息


.微信服务器会发送两种类型的消息给开发者服务器

.get请求验证服务器的有效性

.post请求，转发用户的消息到开发者服务器上

.其它微信不接受(err)
.req.method(获取请求方式)



##获取用户发送的消息

1.暴露出去


2.绑定事件

3.接受完毕绑定事件

##常见问题

当你在微信客户点发送一条消息给微信公众号，这时接收到一个错误，该公众号出现故障，请稍后再试

原因：1.你没有返回响应给微信服务器

2.返回了，但是消息的内容格式错误


3.你返回的不是xml数据


4.xml的数据多删了几个字符

###解决

1.


##接收微信服务器转发用户消息

1.get请求 验证服务器有效性逻辑

验证服务器有效性逻辑

2.post请求

*转发用户消息

  *验证是否来自微信服务器
   *不是显示error，直接return
   *用户发送的消息在请求体
  


3.其它要求（err）







